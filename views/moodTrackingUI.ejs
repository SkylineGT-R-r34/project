<%
  const moodEntries = Array.isArray(moods) ? moods : [];
  let totalScore = 0;
  const dateSet = new Set();
  moodEntries.forEach(entry => {
    const scoreValue = Number(entry.score ?? entry.mood_score ?? 0);
    totalScore += Number.isNaN(scoreValue) ? 0 : scoreValue;
    const rawDate = entry.created_at || entry.date;
    if (rawDate) {
      const parsed = new Date(rawDate);
      if (!Number.isNaN(parsed.getTime())) {
        const normalized = new Date(Date.UTC(parsed.getUTCFullYear(), parsed.getUTCMonth(), parsed.getUTCDate()));
        dateSet.add(normalized.toISOString().split('T')[0]);
      }
    }
  });
  const averageScore = moodEntries.length ? (totalScore / moodEntries.length).toFixed(1) : null;
  let streakDays = 0;
  if (dateSet.size) {
    const today = new Date();
    const cursor = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
    let cursorKey = cursor.toISOString().split('T')[0];
    while (dateSet.has(cursorKey)) {
      streakDays += 1;
      cursor.setUTCDate(cursor.getUTCDate() - 1);
      cursorKey = cursor.toISOString().split('T')[0];
    }
  }
  const body = () => { %>
    <section class="page-section">
      <%- include('partials/pageHeader', { title: 'Mood tracking', subtitle: 'Log your feelings, add short notes, and review recent entries.' }) %>
      <div
        id="mood-tracking"
        data-user-id="<%= user ? user.id : '' %>"
        data-moods='<%- JSON.stringify(moodEntries).replace(/'/g, '&#39;') %>'
        class="mood-layout"
      >
        <div class="mood-card">
          <h2 class="card__title">Log today’s mood</h2>
          <div class="mood-score-buttons">
            <% [1,2,3,4,5,6,7,8,9,10].forEach(score => { %>
              <button type="button" class="mood-score-button" data-score="<%= score %>"><%= score %></button>
            <% }) %>
          </div>
          <form id="mood-form" data-validate class="form-grid">
            <input type="hidden" name="user_id" value="<%= user ? user.id : '' %>" />
            <div class="form-field">
              <label for="mood-score">Selected score</label>
              <input type="number" id="mood-score" name="score" class="form-control" min="1" max="10" required />
            </div>
            <div class="form-field">
              <label for="mood-notes">Notes</label>
              <textarea id="mood-notes" name="notes" rows="3" class="form-control" placeholder="How are you feeling today?"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Save mood</button>
          </form>
          <div class="mood-summary-card">
            <p class="card__text card__text--emphasis">Tracking summary</p>
            <p id="mood-summary-count" class="card__text">Entries logged: <%= moodEntries.length %></p>
            <p id="mood-summary-streak" class="card__text">Current streak: <%= streakDays %> day<%= streakDays === 1 ? '' : 's' %></p>
            <p id="mood-summary-average" class="card__text">Average score: <%= averageScore ?? '—' %></p>
          </div>
        </div>
        <div class="mood-card">
          <div class="mood-history-header">
            <h2 class="card__title">Mood history</h2>
            <div class="range-buttons">
              <button type="button" class="btn btn-outline mood-range" data-range="7">7 days</button>
              <button type="button" class="btn btn-outline mood-range" data-range="30">30 days</button>
              <button type="button" class="btn btn-outline mood-range" data-range="90">90 days</button>
            </div>
          </div>
          <div id="mood-empty" <%= moodEntries.length ? 'hidden' : '' %>>
            <%- include('partials/emptyState', { title: 'No moods logged', message: 'Log your first mood to build your wellbeing timeline.', ctaHref: '#mood-form', ctaLabel: 'Log a mood' }) %>
          </div>
          <div class="table-wrapper">
            <table id="mood-table" class="table" data-has-entries="<%= moodEntries.length > 0 %>">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Score</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody>
                <% moodEntries.forEach(entry => { %>
                  <tr>
                    <td><%= (entry.created_at || entry.date) ? new Date(entry.created_at || entry.date).toLocaleString() : '—' %></td>
                    <td><%= entry.score ?? entry.mood_score %></td>
                    <td><%= entry.notes || entry.note || '—' %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <canvas id="mood-chart" height="160" class="chart-canvas" aria-hidden="true"></canvas>
        </div>
      </div>
    </section>
  <% }; %>
<%- include('layouts/layout') %>
