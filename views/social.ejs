<%
  const searchResults = Array.isArray(results) ? results : [];
  const requestData = typeof requests === 'object' && requests !== null ? requests : {};
  const incomingRequests = Array.isArray(requestData.incoming) ? requestData.incoming : [];
  const outgoingRequests = Array.isArray(requestData.outgoing) ? requestData.outgoing : [];
  const connectionList = Array.isArray(connections) ? connections : [];
  const currentUserId = user ? user.id : '';
  const body = () => { %>
    <section style="display:flex;flex-direction:column;gap:24px;">
      <%- include('partials/pageHeader', { title: 'Social hub', subtitle: 'Find classmates, respond to requests, and keep conversations going.' }) %>
      <div id="social-page" data-user-id="<%= currentUserId %>" style="display:flex;flex-direction:column;gap:24px;">
        <div style="background:#ffffff;border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,0.12);padding:24px 22px;display:flex;flex-direction:column;gap:18px;">
          <h2 style="margin:0;color:#013d37;font-size:1.3rem;">Find people</h2>
          <p style="margin:0;color:#4a4a4a;">Search for students or staff by name or email to connect.</p>
          <label style="display:flex;flex-direction:column;gap:6px;font-weight:600;color:#013d37;">
            Search
            <input type="search" id="social-search" placeholder="Search by name or email" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(1,125,113,0.35);" />
          </label>
          <ul id="social-results" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px;">
            <% if (!searchResults.length) { %>
              <li id="social-results-empty" style="background:rgba(1,125,113,0.06);padding:16px;border-radius:12px;color:#4a4a4a;">Start typing to find people.</li>
            <% } %>
            <% searchResults.forEach(person => { %>
              <li data-user-id="<%= person.id %>" style="background:#ffffff;border:1px solid rgba(1,125,113,0.18);box-shadow:0 8px 22px rgba(0,0,0,0.08);padding:16px 18px;border-radius:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
                <div>
                  <p style="margin:0;font-weight:600;color:#013d37;"> <%= person.full_name || person.name || 'Unknown user' %> </p>
                  <p style="margin:4px 0 0;color:#4a4a4a;font-size:0.9rem;"> <%= person.email %> </p>
                </div>
                <button class="social-add" data-target-id="<%= person.id %>" type="button" style="background:#017d71;color:#ffffff;border:none;padding:8px 14px;border-radius:16px;font-weight:600;">Add</button>
              </li>
            <% }) %>
          </ul>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;">
          <div style="flex:1 1 320px;min-width:280px;background:#ffffff;border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,0.12);padding:24px 22px;display:flex;flex-direction:column;gap:16px;">
            <h2 style="margin:0;color:#013d37;font-size:1.2rem;">Incoming requests</h2>
            <ul id="social-incoming" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px;">
              <% if (!incomingRequests.length) { %>
                <li class="social-empty" style="background:rgba(1,125,113,0.06);padding:16px;border-radius:12px;color:#4a4a4a;">No pending requests.</li>
              <% } %>
              <% incomingRequests.forEach(req => { %>
                <li data-connection-id="<%= req.connection_id || req.id %>" style="background:#ffffff;border:1px solid rgba(1,125,113,0.18);box-shadow:0 8px 22px rgba(0,0,0,0.08);padding:16px 18px;border-radius:14px;display:flex;flex-direction:column;gap:8px;">
                  <div>
                    <p style="margin:0;font-weight:600;color:#013d37;"> <%= req.requester_name || req.full_name || 'Unknown user' %> </p>
                    <p style="margin:4px 0 0;color:#4a4a4a;font-size:0.9rem;"> <%= req.requester_email || req.email %> </p>
                  </div>
                  <div style="display:flex;gap:12px;">
                    <button class="social-accept" data-action="accept" data-connection-id="<%= req.connection_id || req.id %>" type="button" style="background:#017d71;color:#ffffff;border:none;padding:8px 14px;border-radius:16px;font-weight:600;">Accept</button>
                    <button class="social-reject" data-action="reject" data-connection-id="<%= req.connection_id || req.id %>" type="button" style="background:transparent;color:#b02a37;border:1px solid rgba(176,42,55,0.4);padding:8px 14px;border-radius:16px;font-weight:600;">Reject</button>
                  </div>
                </li>
              <% }) %>
            </ul>
          </div>
          <div style="flex:1 1 320px;min-width:280px;background:#ffffff;border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,0.12);padding:24px 22px;display:flex;flex-direction:column;gap:16px;">
            <h2 style="margin:0;color:#013d37;font-size:1.2rem;">Outgoing requests</h2>
            <ul id="social-outgoing" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px;">
              <% if (!outgoingRequests.length) { %>
                <li class="social-empty" style="background:rgba(1,125,113,0.06);padding:16px;border-radius:12px;color:#4a4a4a;">No outgoing requests.</li>
              <% } %>
              <% outgoingRequests.forEach(req => { %>
                <li data-connection-id="<%= req.connection_id || req.id %>" style="background:#ffffff;border:1px solid rgba(1,125,113,0.18);box-shadow:0 8px 22px rgba(0,0,0,0.08);padding:16px 18px;border-radius:14px;display:flex;flex-direction:column;gap:6px;">
                  <p style="margin:0;font-weight:600;color:#013d37;"> <%= req.recipient_name || req.full_name || req.friend_name || 'Pending user' %> </p>
                  <p style="margin:4px 0 0;color:#4a4a4a;font-size:0.9rem;">Status: <%= req.status || 'pending' %></p>
                </li>
              <% }) %>
            </ul>
          </div>
        </div>
        <div style="background:#ffffff;border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,0.12);padding:24px 22px;display:flex;flex-direction:column;gap:16px;">
          <h2 style="margin:0;color:#013d37;font-size:1.3rem;">Connections</h2>
          <ul id="social-connections" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px;">
            <% if (!connectionList.length) { %>
              <li class="social-empty" style="background:rgba(1,125,113,0.06);padding:16px;border-radius:12px;color:#4a4a4a;">You have no connections yet.</li>
            <% } %>
            <% connectionList.forEach(conn => { %>
              <li data-connection-id="<%= conn.connection_id || conn.id %>" style="background:#ffffff;border:1px solid rgba(1,125,113,0.18);box-shadow:0 8px 22px rgba(0,0,0,0.08);padding:16px 18px;border-radius:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
                <div>
                  <p style="margin:0;font-weight:600;color:#013d37;"> <%= conn.friend_name || conn.full_name || 'Connection' %> </p>
                  <p style="margin:4px 0 0;color:#4a4a4a;font-size:0.9rem;">Connected since: <%= conn.connected_at ? new Date(conn.connected_at).toLocaleDateString() : 'Pending' %></p>
                </div>
                <button type="button" class="social-message" style="background:#017d71;color:#ffffff;border:none;padding:8px 14px;border-radius:16px;font-weight:600;">Message</button>
              </li>
            <% }) %>
          </ul>
        </div>
      </div>
    </section>
  <% }; %>
<%- include('layouts/layout') %>
