<%
  const searchResults = Array.isArray(results) ? results : [];
  const requestData = typeof requests === 'object' && requests !== null ? requests : {};
  const incomingRequests = Array.isArray(requestData.incoming) ? requestData.incoming : [];
  const outgoingRequests = Array.isArray(requestData.outgoing) ? requestData.outgoing : [];
  const connectionList = Array.isArray(connections) ? connections : [];
  const currentUserId = user ? user.id : '';
  const body = () => { %>
    <section class="page-section">
      <%- include('partials/pageHeader', { title: 'Social hub', subtitle: 'Find classmates, respond to requests, and keep conversations going.' }) %>
      <div id="social-page" data-user-id="<%= currentUserId %>" class="social-grid">
        <div class="social-panel">
          <h2 class="card__title">Find people</h2>
          <p class="card__text">Search for students or staff by name or email to connect.</p>
          <label class="form-field" for="social-search">
            <span>Search</span>
            <input type="search" id="social-search" class="form-control" placeholder="Search by name or email" />
          </label>
          <ul id="social-results" class="social-list">
            <% if (!searchResults.length) { %>
              <li id="social-results-empty" class="social-empty">Start typing to find people.</li>
            <% } %>
            <% searchResults.forEach(person => { %>
              <li data-user-id="<%= person.id %>" class="social-item social-item--inline">
                <div>
                  <p class="card__text card__text--emphasis"><%= person.full_name || person.name || 'Unknown user' %></p>
                  <p class="social-note"><%= person.email %></p>
                </div>
                <button class="btn btn-primary social-add" data-target-id="<%= person.id %>" type="button">Add</button>
              </li>
            <% }) %>
          </ul>
        </div>
        <div class="social-panels">
          <div class="social-panel">
            <h2 class="card__title">Incoming requests</h2>
            <ul id="social-incoming" class="social-list">
              <% if (!incomingRequests.length) { %>
                <li class="social-empty">No pending requests.</li>
              <% } %>
              <% incomingRequests.forEach(req => { %>
                <li data-connection-id="<%= req.connection_id || req.id %>" class="social-item">
                  <div>
                    <p class="card__text card__text--emphasis"><%= req.requester_name || req.full_name || 'Unknown user' %></p>
                    <p class="social-note"><%= req.requester_email || req.email %></p>
                  </div>
                  <div class="social-actions">
                    <button class="btn btn-primary social-accept" data-action="accept" data-connection-id="<%= req.connection_id || req.id %>" type="button">Accept</button>
                    <button class="btn btn-outline social-reject" data-action="reject" data-connection-id="<%= req.connection_id || req.id %>" type="button">Reject</button>
                  </div>
                </li>
              <% }) %>
            </ul>
          </div>
          <div class="social-panel">
            <h2 class="card__title">Outgoing requests</h2>
            <ul id="social-outgoing" class="social-list">
              <% if (!outgoingRequests.length) { %>
                <li class="social-empty">No outgoing requests.</li>
              <% } %>
              <% outgoingRequests.forEach(req => { %>
                <li data-connection-id="<%= req.connection_id || req.id %>" class="social-item">
                  <p class="card__text card__text--emphasis"><%= req.recipient_name || req.full_name || req.friend_name || 'Pending user' %></p>
                  <p class="social-note">Status: <%= req.status || 'pending' %></p>
                </li>
              <% }) %>
            </ul>
          </div>
        </div>
        <div class="social-panel">
          <h2 class="card__title">Connections</h2>
          <ul id="social-connections" class="social-list">
            <% if (!connectionList.length) { %>
              <li class="social-empty">You have no connections yet.</li>
            <% } %>
            <% connectionList.forEach(conn => { %>
              <li data-connection-id="<%= conn.connection_id || conn.id %>" class="social-item social-item--inline">
                <div>
                  <p class="card__text card__text--emphasis"><%= conn.friend_name || conn.full_name || 'Connection' %></p>
                  <p class="social-note">Connected since: <%= conn.connected_at ? new Date(conn.connected_at).toLocaleDateString() : 'Pending' %></p>
                </div>
                <button type="button" class="btn btn-primary social-message">Message</button>
              </li>
            <% }) %>
          </ul>
        </div>
      </div>
    </section>
  <% }; %>
<%- include('layouts/layout') %>
